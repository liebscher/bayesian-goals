<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bayesian Reading Goals</title>
    <link rel="stylesheet" href="style.css">

    <!-- import handlebars for simple templating capabilities -->
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
  </head>
  <body>
    <div class="main-container">
      <div class="dates-container">
        <div class="">
          <label for="start-date-field">Start Date</label>
          <input type="date" name="start-date-field" value="">
        </div>
        <div class="">
          <label for="end-date-field">End Date</label>
          <input type="date" name="end-date-field" value="">
        </div>
      </div>

      <div class="goal-container">
        <label for="goal-field">Goal</label>
        <input type="number" name="goal-field" value="">
        <select class="" name="goal-unit-field">
          <option value="mpd">minutes per day</option>
          <option value="ppd">pages per day</option>
          <option value="th">total hours</option>
          <option value="tp">total pages</option>
        </select>
      </div>

      <div class="data-feld-container">
          <textarea name="data-field" rows="8" cols="80"></textarea>
      </div>

      <div class="outcome-container">
        <h4>The probability you meet your goal is:</h4>
        <h3 id="outcome-probability"></h3>
        <div class="">
          <p id="outcome-plan"></p>
          <p id="outcome-history"></p>
        </div>
        <div class="plot-container">
          Distribution plot here
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">

    const MS_IN_DAY = 1000 * 60 * 60 * 24
    const UNITS = {
      "hours": "hours",
      "pages": "pages"
    }
    const SCALE = {
      "perday": "per day",
      "total": "total"
    }

    // templates:
    var probability_t = Handlebars.compile("{{prob}}%");
    var plan_t = Handlebars.compile("Over your {{days}} day period, you'd have to read {{pace}} {{unit}}");
    var history_t = Handlebars.compile("Historically, you read on average {{average}} {{unit}}");

    // specify the unit of the goal: will be pages or hours (or something else)
    var unit = UNITS.hours
    var scale = SCALE.perday

    var startDate = null
    var endDate = null
    var days = null // the total number of the days in the goal period
    var goal = null // the numerical goal, unitless

    // set default values for the outcomes
    document.getElementById("outcome-probability").innerText = probability_t({prob: 0})
    document.getElementById("outcome-plan").innerText = plan_t({days: "NA", pace: "NA", unit: "hours per day"})
    document.getElementById("outcome-history").innerText = history_t({average: "NA", unit: "hours per day"})

    // grab the DOM elements for parameters
    var startDateField = document.getElementsByName("start-date-field")[0]
    var endDateField = document.getElementsByName("end-date-field")[0]
    var goalField = document.getElementsByName("goal-field")[0]
    var goalUnitField = document.getElementsByName("goal-unit-field")[0]

    // update the start date of the goal
    var updateStartDate = (date) => {
      startDate = date;
    }

    // update the end date of the goal
    var updateEndDate = (date) => {
      endDate = date;
    }

    // update the numerical goal, regardless of units or scale
    var updateGoal = (_goal) => {
      goal = _goal;
    }

    // update the unit and scale structures
    var updateGoalUnit = (selector) => {
      switch (selector) {
        case "mpd":
          unit = UNITS.hours
          scale = SCALE.perday
          break;
        case "th":
          unit = UNITS.hours
          scale = SCALE.total
          break;
        case "ppd":
          unit = UNITS.pages
          scale = SCALE.perday
          break;
        case "tp":
          unit = UNITS.pages
          scale = SCALE.total
          break;
      }
    }

    // update the number of days in the period
    var updateDays = () => {
      if (startDate && endDate) {
        days = (endDate - startDate) / MS_IN_DAY
      }
    }

    // separate concerns and refresh plan outcome
    var refreshPlanOutcome = () => {
      let _pace = "NA";
      let _days = "NA"
      let _units = unit + " per day"

      // if the dates have been set, display the # of days
      if (days) {
        _days = days
      }

      // if both the goal and the days are set, display the pace
      if (goal && days) {
        // figure out how to scale the pace
        if (scale == SCALE.total) _pace = goal / days
        else if (unit == UNITS.hours) _pace = goal / 60
        else _pace = goal * 1.0

        _pace = _pace.toFixed(1) // for pretty printing

        // we shouldn't recommend more than 24 hours of reading per day
        if (unit == UNITS.hours && _pace >= 24) {
          _pace = "NA"
        }
      }

      document.getElementById("outcome-plan").innerText = plan_t({days: _days, pace: _pace, unit: _units})
    }

    // event listeners
    startDateField.addEventListener('change', (event) => {
      updateStartDate(new Date(event.target.value))
      updateDays()
      refreshPlanOutcome()
    });

    endDateField.addEventListener('change', (event) => {
      updateEndDate(new Date(event.target.value))
      updateDays()
      refreshPlanOutcome()
    });

    goalField.addEventListener('change', (event) => {
      updateGoal(event.target.value)
      refreshPlanOutcome()
    });

    goalUnitField.addEventListener('change', (event) => {
      updateGoalUnit(event.target.value)
      refreshPlanOutcome()
    });

  </script>
</html>
